[Global]
logfile: autotest.log

# ucs-kt-get kvm settings
kvm_server: [ENV:KVM_BUILD_SERVER]
kvm_user: [ENV:KVM_USER]
kvm_extra_label: openstack-appliance-[ENV:UCS_VERSION]
kvm_template: [ENV:KVM_TEMPLATE]
kvm_ucsversion: [ENV:KVM_UCSVERSION]
kvm_operating_system: [ENV:KVM_OPERATING_SYSTEM]
kvm_architecture: amd64
kvm_memory: 6G
kvm_dhcp: true
needs_openstack: true

recover: 2

environment:
 # upload images to univention-image project
 OS_CLOUD=univention-images
 UCS_VERSION=[ENV:UCS_VERSION]
 UCS_TEST_RUN=[ENV:UCS_TEST_RUN]
 RELEASE_UPDATE=[ENV:RELEASE_UPDATE]
 ERRATA_UPDATE=[ENV:ERRATA_UPDATE]
 TARGET_VERSION=[ENV:TARGET_VERSION]
 JENKINS_WS=[ENV:JOB_URL

[openstack-appliance]
command1:
 . utils.sh && basic_setup
 . utils.sh && add_tech_key_authorized_keys
 # copy openstack credentials
 mkdir -p /etc/openstack/
 LOCAL scp -i ~/ec2/keys/tech.pem -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no /etc/openstack/clouds.yml root@[SELF_IP]:/etc/openstack/
 # setup
 ucr set repository/online=true
 apt-get update
 wget -O - https://apt.releases.hashicorp.com/gpg |  gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
 echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" |  tee /etc/apt/sources.list.d/hashicorp.list
 apt-get update
 apt-get install -y packer qemu-system-x86 libguestfs-tools python3-openstackclient
 # build image
 cd packer-scripts/ && PACKER_LOG=1 packer init  .
 # TODO: build without kvm, once we have a dedicated packer server, we might want to change that
 cd packer-scripts/ && PACKER_LOG=1 packer build -var "version=[ENV:UCS_VERSION]" -var "testing=[ENV:TESTING]" -var "accelerator=none" -var "cpu_model=max" -only=qemu.kvm-ucs .
 cd packer-scripts/ && virt-sysprep -a ucs/ucs[ENV:UCS_VERSION].raw --no-logfile --operations bash-history,logfiles,dhcp-client-state,mail-spool,customize,machine-id
 # upload to openstack (preview)
 openstack image delete "UCS [ENV:UCS_VERSION] preview" || true
 cd packer-scripts/ && openstack image create --progress --file ucs/ucs[ENV:UCS_VERSION].raw --disk-format raw --container-format bare --min-disk 5 --min-ram 2048 --shared --property U_default_user=root --property U_default_pw=univention --property U_image_infos=https://helpdesk.knut.univention.de/help/en-us/15/82 --property hw_disk_bus=scsi --property hw_scsi_model=virtio-scsi --property hw_rng_model=virtio --property hw_watchdog_action=reset --property hypervisor_type=kvm "UCS [ENV:UCS_VERSION] preview"
command2:
 . utils.sh && prepare_results
 LOCAL utils/utils-local.sh fetch-results [SELF_IP]
