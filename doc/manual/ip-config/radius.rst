.. SPDX-FileCopyrightText: 2021-2025 Univention GmbH
..
.. SPDX-License-Identifier: AGPL-3.0-only

.. _ip-config-radius:

RADIUS
======

The :program:`RADIUS` app increases the security for UCS managed IT
infrastructures by controlling the access to the wireless network for users,
groups and endpoint devices via `RADIUS protocol <w-radius_>`_. The
configuration is done via deny and allow lists and directly at user, group and
endpoint device objects in the UCS management system. Registered users are
authenticated with their usual domain credentials or, alternatively, with a
specifically for RADIUS generated password, which, among others, also allows
bring your own device concepts.

.. _ip-config-radius-installation:

Installation
------------

:program:`RADIUS` is available through the App Center (see
:ref:`software-appcenter`) and can be installed using the UMC module
:guilabel:`App Center`. It can be installed on multiple machines. After the
installation it runs a `FreeRADIUS <freeradius_>`_ server.
Authenticators (e.g.  access points) can contact via RADIUS to check network
access requests.

The RADIUS app can also be installed on UCS\@school systems. In this case, the
network access can be given to users or groups regardless of the internet rule
or computer room settings.

.. _ip-config-radius-configuration:

Configuration
-------------

.. _ip-config-radius-configuration-allowed-users:

Allowed users
~~~~~~~~~~~~~

By default no user is allowed to access the network. Enabling the checkbox for
*network access* on the *RADIUS* tab, gives the user access to the network. The
checkbox can also be set on groups, which allows all users in this group access.

.. _ip-config-radius-group:

.. figure:: /images/radius-group-allow-network.*
   :alt: Example for a group allowing network access to its users

   Example for a group allowing network access to its users

.. _ip-config-radius-configuration-service-specific-password:

Service specific password
~~~~~~~~~~~~~~~~~~~~~~~~~

By default, users authenticate with their domain password.
RADIUS uses a specific password,
if an administrator sets the |UCSUCRV|
:envvar:`radius/use-service-specific-password` to ``true``.
Users can request a password specific to wireless LAN use
through the
:ref:`Self Service app <user-management-password-changes-by-users>`.
UCS generates a random password for each password request
from the :program:`Self Service`.
If necessary, users can generate a random password at any time,
which also invalidates the existing password.

To enable the service specific password page in the :program:`Self Service` app,
the administrator must set the |UCSUCRV|
:envvar:`umc/self-service/service-specific-passwords/backend/enabled`
to the value ``true`` on the UCS system
that has the :program:`Self Service Backend` app installed.

.. _ip-config-radius-selfservice:

.. figure:: /images/radius-service-specific-password.*
   :alt: The page in the Self Service to get a RADIUS specific password

   The page in the Self Service to get a RADIUS specific password

UCS allows configuring the password quality for the auto generated service specific passwords
through the following |UCSUCRVs|.
For a description,
see the references to the respective generic password quality settings.

.. _ip-config-radius-configuration-service-specific-password-table:

.. list-table:: Password quality parameters for RADIUS
   :header-rows: 1
   :width: 90%

   * - RADIUS password quality parameter
     - Generic password quality parameter

   * - ``password/radius/quality/credit/digits``
     - :envvar:`password/quality/credit/digits`

   * - ``password/radius/quality/credit/lower``
     - :envvar:`password/quality/credit/lower`

   * - ``password/radius/quality/credit/other``
     - :envvar:`password/quality/credit/other`

   * - ``password/radius/quality/credit/upper``
     - :envvar:`password/quality/credit/upper`

   * - ``password/radius/quality/forbidden/chars``
     - :envvar:`password/quality/forbidden/chars`

   * - ``password/radius/quality/length/min``
     - :envvar:`password/quality/length/min`

.. important::

   The settings in the ``password/quality/**`` |UCSUCRVs| don't have an effect on the service specific password.

To configure the password quality,
choose the scenario on the following tabs
that matches your environment where you installed the :program:`RADIUS` app.

.. tab:: RADIUS on Primary

   To configure the password quality,
   use the following steps.

   Prerequisite
      You have the :program:`RADIUS` app installed on the |UCSPRIMARYDN|.

   #. For available password quality parameters,
      either look at
      :numref:`ip-config-radius-configuration-service-specific-password-table`,
      or at your system.

      **On the Primary Directory Node**,
      open the command-line
      and lookup the available password quality parameters:

      .. code-block:: console

         $ ucr search password/radius/quality

   #. Pick the parameter that you want to change and set the respective |UCSUCRv|,
      for example the minimal password length.

      .. code-block:: console

         $ ucr set password/radius/quality/length/min=32

.. tab:: RADIUS on other UCS systems

   To configure the password quality,
   use the following steps.

   Prerequisite
      You have the :program:`RADIUS` app installed on a UCS system
      **other than** the |UCSPRIMARYDN|.

   #. For available password quality parameters,
      either look at
      :numref:`ip-config-radius-configuration-service-specific-password-table`,
      or at your system.

      **On the UCS system**
      that has the :program:`RADIUS` app installed,
      open the command-line
      and lookup the available password quality parameters:

      .. code-block:: console

         $ ucr search password/radius/quality

   #. Pick the parameter that you want to change and set the respective |UCSUCRv|,
      for example the minimal password length.
      On the |UCSPRIMARYDN|,
      open the command-line and run the following command:

      .. code-block:: console

         $ ucr set password/radius/quality/length/min=32

3. Regardless the scenario,
   you finally need to restart the *UDM HTTP REST API* on the |UCSPRIMARYDN|.
   Open the command-line and run the following command.

   .. code-block:: console

      $ systemctl restart univention-directory-manager-rest.service

.. _ip-config-radius-configuration-mac-filtering:

MAC filtering
~~~~~~~~~~~~~

By default access to the network is allowed for every device (assuming the used
username has access). It can be restricted to only allow specific devices. This
can be enabled by setting the |UCSUCRV| :envvar:`radius/mac/whitelisting` to
``true``. When enabled, the device used to access the network is looked up via
the LDAP attribute ``macAddress`` and the resulting computer object must have
network access granted (either directly or via one of its groups), too.

.. _ip-config-radius-configuration-mab:

MAC Authentication Bypass with computer objects
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

MAC Authentication Bypass (MAB) is a proprietary fallback mode to 802.1X
for devices that don't support 802.1X authentication,
such as network printers or wireless phones.
MAB is an option that allows such devices to authenticate with the network
using their MAC address as their username.

This section describes how to use a device's MAC address for authentication
and assign them a VLAN to the corresponding network infrastructure through MAB.
To activate MAC Authentication Bypass, set the |UCSUCRV|
:envvar:`freeradius/conf/allow-mac-address-authentication` to ``true``.

.. important::

   Devices that authenticate using MAB ignore network access settings:

   * |UCSUCRV| :envvar:`radius/mac/whitelisting`

   * The checkbox *Allow network access* at the computer object and in the group setting

.. warning::

   Attackers can spoof MAC addresses.
   Consider any port as compromised where your switch allows to use MAB.
   Make sure you have put appropriate measures in place to still keep your network secure.

.. tab:: Assign VLAN ID to computer

   To assign the VLAN ID to a computer,
   you need to add it to the group of the computer object with the respective VLAN ID.
   In the UCS management system, follow these steps:

   #. Open :menuselection:`Devices --> Computers`.

   #. Click the computer object to edit.

   #. Go to :menuselection:`Advanced settings --> Groups`.

   #. To add a group with VLAN IDs, click :guilabel:`+ ADD`,
      select ``Virtual LAN ID`` from the *Object property* drop-down,
      and activate the appropriate group to add it.

   #. To save, click :guilabel:`ADD` in the *Add objects* dialog
      and :guilabel:`SAVE` in the *Advanced settings*.

.. tab:: Assign VLAN ID to user group

   To assign the VLAN ID to a user group, you need to add it to the user group settings.
   In the UCS management system, follow these steps:

   #. Open :menuselection:`Users --> Groups`.

   #. Click the user group object to edit or create a new user group.

   #. Go to :menuselection:`RADIUS`.

   #. Enter the VLAN ID as number into the field *Virtual LAN ID*.

   #. To save, click :guilabel:`SAVE`.

If a computer object has assigned several groups with VLAN IDs,
UCS selects the VLAN ID with the lowest number and assigns it.
To configure a default VLAN ID, set it as value to the |UCSUCRV|
:envvar:`freeradius/vlan-id`.

After you completed the configuration,
the Radius server returns the assigned VLAN ID to requests with the given MAC address.

UCS stores the MAC address in the LDAP directory as lowercase string with the
colon (``:``) as separator, for example ``00:00:5e:00:53:00``.


.. versionadded:: 5.0-6-erratum-1011

   With :uv:erratum:`5.0x1011` the Radius server
   can handle different formats of the MAC addresses for the username when using MAB.

Devices that use MAB, use their MAC address as username
and they may use different formats for it.
The Radius server supports different case-sensitive formats.
The following list shows the tested formats:

* ``XX:XX:XX:XX:XX:XX``
* ``XX-XX-XX-XX-XX-XX``
* ``XX.XX.XX.XX.XX.XX``
* ``XXXX.XXXX.XXXX``
* ``XXXXXXXXXXXX``

.. note::

   For non-standard formats, you can configure a regular expression in the |UCSUCRV|
   :envvar:`freeradius/conf/mac-addr-regexp` to match your custom MAC address format.

   Depending on your regular expression, the previously listed formats may not work anymore.

.. important::

   All devices that use MAB, need to have the same password set,
   because :ref:`service specific passwords <ip-config-radius-configuration-service-specific-password>` don't work,
   and the switch must know the password.
   You can only configure one device password in the switch.
   You can make up your own password for the devices using MAB,
   for example ``mab request format attribute 2 password1``.

   If the network infrastructure provides a different format,
   you can often reconfigure the format.
   For example, for Cisco switches, you can use ``mab request format attribute 1 groupsize 2 separator : lowercase``
   as described in
   `Configurable MAB Username and Password
   <https://www.cisco.com/c/en/us/td/docs/ios-xml/ios/sec_usr_aaa/configuration/15-e/sec-usr-aaa-15-e-book/sec-usr-config-mab-usrname-pwd.html>`_.


.. _ip-config-radius-configuration-access-points-registration:

Access point administration
~~~~~~~~~~~~~~~~~~~~~~~~~~~

All access points must be known to the RADIUS server. An access point can either
be configured in the file :file:`/etc/freeradius/3.0/clients.conf` or through
the UMC module :guilabel:`Computers`. For each access point a random shared
secret should be created (e.g. by using the command :command:`makepasswd`). The
``shortname`` can be chosen at will.

Example entry for an access point:

.. code-block::

   client AP01 {
       secret = a9RPAeVG
       ipaddr = 192.0.2.101
   }

To configure an access point using the UMC module :guilabel:`Computers` create
or select a computer object and activate the *RADIUS-Authenticator* option
(:ref:`ip-config-radius-option`). An *IP client* is a good choice as a computer
object for access points. The RADIUS settings can be edited on the *RADIUS* tab
of the object (:ref:`ip-config-radius-authenticator`). At least the IP address
and the shared secret must be configured. The virtual server and NAS type
options usually do not need to be changed.

Access points that are configured via the UMC module :guilabel:`Computers` are
available to all RADIUS servers in the domain. To achieve this, the |UCSUDL|
will write them into the file
:file:`/etc/freeradius/3.0/clients.univention.conf` and restart the RADIUS
server. In order to merge multiple changes in one restart, this happens with a
slight delay (around 15 seconds). New access points can only access the RADIUS
server after this restart.

.. _ip-config-radius-option:

.. figure:: /images/radius_option.*
   :alt: RADIUS option

   RADIUS option

.. _ip-config-radius-authenticator:

.. figure:: /images/radius_authenticator.*
   :alt: RADIUS authenticator options

   RADIUS authenticator options

.. _ip-config-radius-configuration-access-points-clients:

Access point and client configuration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

The access points must then be configured to use 802.1x ("WPA Enterprise")
authentication. And the *RADIUS server* address should be set to the address of
the server, where the RADIUS app is installed. The password must be set to the
``secret`` from the :file:`clients.conf` entry for that access point.

Wireless clients have to be configured to use *WPA* with *PEAP* and *MSCHAPv2* for
authentication.

.. _ip-config-radius-configuration-vlanid-configuration:

VLAN IDs
~~~~~~~~

Virtual Local Area Networks (VLANs) can be used to separate the traffic of users
at the network level. UCS can be configured to return a VLAN ID in the Radius
response of the Radius authentication process according to :rfc:`RFC 3580 / IEEE 802.1X
<3580>`. You find further information in :ref:`computers-network-complex-vlan`.

The VLAN ID for a user can be configured by assigning the user to a group with a VLAN ID.

.. _radius-vlanid-group:

.. figure:: /images/radius-vlanid-group.*
   :alt: Assigning VLAN ID to a user group

   Assigning VLAN ID to a user group

A default VLAN ID can be configured in the |UCSUCRV| :envvar:`freeradius/vlan-id`. This default
VLAN ID will be returned if the user is not a member of a group with a VLAN ID. The Radius
response will not contain any VLAN ID in case the user is not a member of a group with
VLAN ID and no default VLAN ID is defined.

.. _ip-config-radius-disable-tls-1-3:

Disable TLS 1.3
~~~~~~~~~~~~~~~

Radius uses Transport Layer Security (TLS) to encrypt web traffic.
The current version of all major operating systems supports TLS 1.3.
Some operating systems, such as Microsoft Windows 10, have issues with the Radius implementation used.
For detailed information, see :uv:bug:`55247`.

If you still use those, you might have to to disable TLS v1.3.
To limit TLS to version 1.2,
change the |UCSUCRV| :envvar:`freeradius/conf/tls-max-version` to the value ``1.2``.

.. _ip-config-radius-debugging:

Debugging
---------

The :program:`RADIUS` app has a log file under
:file:`/var/log/univention/radius_ntlm_auth.log`. The log verbosity can the
controlled via the |UCSUCRV| :envvar:`freeradius/auth/helper/ntlm/debug`. The
:program:`FreeRADIUS server` uses the log file:
:file:`/var/log/freeradius/radius.log`.

The tool :program:`univention-radius-check-access` can be used to evaluate the
current access policy for a given user and/or station ID (MAC address). It can
be executed as root on the server where :program:`univention-radius` its
installed:

.. code-block:: console

   root@primary211:~# univention-radius-check-access --username=stefan --station-id none
   DENY 'uid=stefan,cn=users,dc=ucs,dc=example'
   'uid=stefan,cn=users,dc=ucs,dc=example'
   -> DENY 'cn=Domain Users,cn=groups,dc=ucs,dc=example'
   -> 'cn=Domain Users,cn=groups,dc=ucs,dc=example'
   -> -> DENY 'cn=Users,cn=Builtin,dc=ucs,dc=example'
   -> -> 'cn=Users,cn=Builtin,dc=ucs,dc=example'
   Thus access is DENIED.

.. code-block:: console

   root@primary211:~# univention-radius-check-access --username=janek --station-id none
   DENY 'uid=janek,cn=users,dc=ucs,dc=example'
   'uid=janek,cn=users,dc=ucs,dc=example'
   -> DENY 'cn=Domain Users,cn=groups,dc=ucs,dc=example'
   -> ALLOW 'cn=Network Access,cn=groups,dc=ucs,dc=example'
   -> 'cn=Domain Users,cn=groups,dc=ucs,dc=example'
   -> -> DENY 'cn=Users,cn=Builtin,dc=ucs,dc=example'
   -> -> 'cn=Users,cn=Builtin,dc=ucs,dc=example'
   -> 'cn=Network Access,cn=groups,dc=ucs,dc=example'
   Thus access is ALLOWED.
   root@primary211:~#

It prints a detailed explanation and sets the exit code depending on the result
of the access check (``0`` for *access granted*, ``1`` for *access denied*).
